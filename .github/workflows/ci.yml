name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  test-cpu:
    runs-on: ubuntu-latest
    env:
      TINKER_API_KEY: ${{ secrets.TINKER_API_KEY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure pip cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          # Avoid caching editable/local environment installs; only cache downloaded packages
          # referenced in this workflow (e.g., tinker, verifiers, torch).
          key: ${{ runner.os }}-pip-${{ hashFiles('.github/workflows/ci.yml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu

      - name: Install tinker dependencies
        run: |
          pip install tinker tinker_cookbook

      - name: Install local packages with test extras
        run: |
          pip install --no-build-isolation verifiers
          python - <<'PY'
          import subprocess
          import sys
          from pathlib import Path

          envs_dir = Path("environments")
          if not envs_dir.exists():
              raise SystemExit("Missing environments directory")

          for env_dir in sorted(envs_dir.iterdir()):
              if (env_dir / "pyproject.toml").exists():
                  print(f"Installing env package: {env_dir.name}")
                  subprocess.check_call([
                      sys.executable,
                      "-m",
                      "pip",
                      "install",
                      "-e",
                      str(env_dir),
                  ])
          PY

      - name: Lint
        run: |   
          python -m pip install ruff
          ruff check .

      - name: Run tests
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN || '' }}
        run: |
          python -m pip install pytest
          pytest tests/ -v
