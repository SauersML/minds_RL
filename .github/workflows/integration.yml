name: Manual Integration Test (Real API)

on:
  workflow_dispatch:

jobs:
  real-api-test:
    runs-on: ubuntu-latest
    env:
      TINKER_API_KEY: ${{ secrets.TINKER_API_KEY }}
      # Optional: If your verifiers/models require HF access
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
      WANDB_PROJECT: minds-rl

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Configure pip cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          # Cache only downloaded third-party artifacts (tinker, tinker_cookbook, verifiers, torch)
          # and avoid caching editable/local environment installs.
          key: ${{ runner.os }}-pip-integration-${{ hashFiles('.github/workflows/integration.yml') }}
          restore-keys: |
            ${{ runner.os }}-pip-integration-

      - name: Install Real Dependencies
        # We explicitly install the real SDKs here.
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          
          # Install the Real Tinker SDK and Cookbook
          pip install tinker tinker_cookbook
          
          # Install Verifiers and local packages
          pip install --no-build-isolation verifiers
          pip install -e "./custom_utils"
          pip install -e "./environments/self_prediction"
          pip install -e "./environments/ghost_trace"
          pip install -e "./environments/gradient_prophet"

      - name: Check model and steps
        run: |          
          # Verify the changes
          grep "TINKER_MODEL =" examples/env_runner.py
          grep "MAX_STEPS =" examples/env_runner.py

      - name: Run Integration Examples (Real)
        # This runs env_runner.py, which creates configs and calls Trainer.train()
        run: |
          python examples/env_runner.py

      - name: Upload training artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-training-artifacts
          path: runs/
